pipeline{
    agent any
    stages{
        stage ("build") {
            steps {
                sh "make debug"
            }
        }
        stage ("get-test-script"){
            steps{
                sh "wget https://raw.githubusercontent.com/sunilkr/elf-tests/master/test-debug.sh"
                sh "chmod u+x test-debug.sh"
            }
        }
        stage("test"){
            steps {
                script {
                    def res = sh returnStatus:true, script:"./test-debug.sh bin/debug/cproj1"
                    if (res > 0) {
                        currentBuild.result="UNSTABLE"
                        echo "${res} tests failed."
                    }
                }
            }
        }
    }
    post{
        always{
            sh "make clean"
            sh "rm test-debug.sh"
        }
    }
}
